{%- set _lazy = lazy ?? true -%}
{%- set _sizes = sizes ?? [768, 1536] -%}
{%- set _sizesAttr = sizesAttr ?? '100vw' -%}
{%- set _aspectRatio = aspectRatio ?? '' -%}
{%- set _ratio = ratio ?? null -%}
{%- set _quality = quality ?? 85 -%}
{%- set _objectFit = objectFit ?? false -%}
{%- set _class = class ?? '' -%}
{%- set _pictureClass = pictureClass ?? '' -%}
{%- set _imgOnly = imgOnly ?? false -%}
{%- set _showCaption = showCaption ?? false -%}
{%- set _allowedExtensions = ['png', 'jpg', 'jpeg', 'webp', 'avif', 'JPG', 'PNG', 'JPEG'] -%}
{%- set _formats = formats ?? ['webp', 'jpeg'] -%}
{%- set _lqip = lqip ?? false -%}
{%- set _lqipWidth = lqipWidth ?? 20 -%}
{%- set _lqipQuality = lqipQuality ?? 30 -%}

{%- if image -%}
  {%- set url = image.getUrl() -%}
  {%- set extension = image.extension -%}
  {%- set altText = image.alt ?? '' -%}
  {%- set focalPoint = image.getFocalpoint('asCss') ?? '50% 50%' -%}
  {%- set style = _objectFit ? 'height: 100%; width: 100%; object-fit: cover; object-position: ' ~ focalPoint : '' -%}
  {%- set isTranformable = extension in _allowedExtensions -%}
  {%- set imageClass = _aspectRatio ~ ' ' ~ _class -%}
  {%- set tinyPlaceholder = _lqip ? image.url({ width: _lqipWidth, quality: _lqipQuality, format: 'jpeg' }) : null -%}

  {%- if isTranformable -%}
    {%- set srcsets = { jpeg: [], webp: [], avif: [] } -%}

    {%- for outputWidth in _sizes -%}
      {%- set transformOptions = { width: outputWidth, quality: _quality } -%}
      {%- if _ratio -%}
        {%- set splitRatio = _ratio|split(':') -%}
        {%- set transformOptions = transformOptions|merge({ height: outputWidth * (splitRatio|last) / (splitRatio|first) }) -%}
      {%- endif -%}

      {# JPEG #}
      {%- if 'jpeg' in _formats -%}
        {%- set srcsets = srcsets|merge({ jpeg: srcsets.jpeg|merge([image.url(transformOptions) ~ ' ' ~ outputWidth ~ 'w']) }) -%}
      {%- endif -%}

      {# WebP optional #}
      {%- if 'webp' in _formats and craft.app.images.supportsWebP() -%}
        {%- set srcsets = srcsets|merge({ webp: srcsets.webp|merge([image.url(transformOptions|merge({ format: 'webp' })) ~ ' ' ~ outputWidth ~ 'w']) }) -%}
      {%- endif -%}

      {# AVIF optional #}
      {%- if 'avif' in _formats -%}
        {%- set srcsets = srcsets|merge({ avif: srcsets.avif|merge([image.url(transformOptions|merge({ format: 'avif' })) ~ ' ' ~ outputWidth ~ 'w']) }) -%}
      {%- endif -%}
    {%- endfor -%}

    {%- set srcsetStrings = {
      jpeg: srcsets.jpeg|join(', '),
      webp: srcsets.webp|join(', '),
      avif: srcsets.avif|join(', ')
    } -%}

    {%- if _imgOnly -%}
      <img src="{{ url }}"
           srcset="{{ srcsetStrings.jpeg }}"
           class="{{ imageClass }}"
           width="{{ image.width }}"
           height="{{ image.height }}"
           alt="{{ altText }}"
           sizes="{{ _sizesAttr }}"
        {{ _lazy ? ' loading="lazy"' }}
        {% if _objectFit %} style="{{ style }}"{% endif %}/>
    {%- else -%}
      <picture class="ui-picture {{- _lqip ? ' ui-picture-blur' : '' }} {{- _pictureClass -}}"
        {% if _lqip %} style="--lqip: url('{{ tinyPlaceholder }}');"{% endif %}>
        {%- if 'avif' in _formats and srcsetStrings.avif -%}
          <source type="image/avif" srcset="{{ srcsetStrings.avif }}" sizes="{{ _sizesAttr }}" />
        {%- endif -%}
        {%- if 'webp' in _formats and srcsetStrings.webp -%}
          <source type="image/webp" srcset="{{ srcsetStrings.webp }}" sizes="{{ _sizesAttr }}" />
        {%- endif -%}
        {%- if 'jpeg' in _formats and srcsetStrings.jpeg -%}
          <source type="image/jpeg" srcset="{{ srcsetStrings.jpeg }}" sizes="{{ _sizesAttr }}" />
        {%- endif -%}
        <img src="{{ url }}"
             srcset="{{ srcsetStrings.jpeg }}"
             class="{{ imageClass }}"
             width="{{ image.width }}"
             height="{{ image.height }}"
             alt="{{ altText }}"
             sizes="{{ _sizesAttr }}"
             onload="this.parentElement.classList.add('is-loaded')"
          {{ _lazy ? ' loading="lazy"' }}
          {% if _objectFit %} style="{{ style }}"{% endif %}/>
      </picture>
    {%- endif -%}
  {%- else -%}
    <img src="{{ url }}"
         class="{{ imageClass }}"
         width="{{ image.width }}"
         height="{{ image.height }}"
         alt="{{ altText }}"
         sizes="{{ _sizesAttr }}"
      {{ _lazy ? ' loading="lazy"' }}
      {% if _objectFit %} style="{{ style }}"{% endif %}/>
  {%- endif -%}
{%- endif -%}
